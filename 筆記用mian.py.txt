import cv2
import base64
import time
import threading
import signal
import sys
from flask import Flask
from flask_socketio import SocketIO

from function.dobot_controller import DobotController
from function.vision_processor import VisionProcessor
from function.audio_controller import AudioController
from function.object_counter import ObjectCounter

# å…¨åŸŸè®Šæ•¸å®£å‘Š
app = Flask(__name__)
socketio = SocketIO(app)

# åˆå§‹åŒ–å„æ¨¡çµ„
dobot = DobotController()
vision = VisionProcessor()
audio = AudioController()

# æ§åˆ¶è®Šæ•¸
running = True
flag_start_work = False
color_state = "None"
state = "None"
SLEEP_TIME = 0  # ç§»é™¤ä¸å¿…è¦çš„å»¶é²
CONVEYOR_SPEED = 50  # ä¾‹å¦‚ï¼šæ¯ç§’ 50 pixel
PREDICTION_TIME = 0.87871  # ç²¾ç¢ºçš„é åˆ¤æ™‚é–“ï¼š0.87871 ç§’
PICKUP_DELAY = 0.87871  # åˆ°é”æŒ‡å®šä½ç½®çš„æ™‚é–“ï¼š0.87871 ç§’
noweb_mode = False  # æ–°å¢ï¼šnoweb æ¨¡å¼æ¨™è¨˜

# è™•ç†ä¸­çš„ç‰©ä»¶è¨˜éŒ„ï¼ˆé¿å…é‡è¤‡è™•ç†ï¼‰
processed_objects = set()
processing_lock = threading.Lock()

# æ ¹æ“šæ˜¯å¦ç‚º noweb æ¨¡å¼åˆå§‹åŒ– counter
if len(sys.argv) > 1 and sys.argv[1] == "noweb":
    noweb_mode = True
    counter = None  # noweb æ¨¡å¼ä¸‹ä¸ä½¿ç”¨ socketio
    print("ğŸš€ å•Ÿå‹• noweb æ¨¡å¼")
else:
    counter = ObjectCounter(socketio)
    print("ğŸŒ å•Ÿå‹• web æ¨¡å¼")

def get_object_id(obj):
    """ç”Ÿæˆç‰©ä»¶å”¯ä¸€IDï¼ˆåŸºæ–¼ä½ç½®å’Œé¡åˆ¥ï¼‰"""
    cX, cY = obj['center']
    class_name = obj['class']
    # ä½¿ç”¨ç²—ç•¥ä½ç½®é¿å…å¾®å°ä½ç§»é€ æˆçš„é‡è¤‡ID
    rough_x = round(cX / 20) * 20
    rough_y = round(cY / 20) * 20
    return f"{class_name}_{rough_x}_{rough_y}"

def process_object_async(obj, detection_time):
    """ç•°æ­¥è™•ç†ç‰©ä»¶ï¼ˆé¿å…é˜»å¡ä¸»è¿´åœˆï¼‰"""
    global processed_objects
    
    cX, cY = obj['center']
    class_name = obj['class']
    obj_id = get_object_id(obj)
    
    # æª¢æŸ¥æ˜¯å¦å·²ç¶“è™•ç†é
    with processing_lock:
        if obj_id in processed_objects:
            return
        processed_objects.add(obj_id)
    
    try:
        print(f"ğŸ¯ é–‹å§‹è™•ç†ç‰©ä»¶: {class_name} at ({cX}, {cY})")
        
        # è¨ˆç®—é åˆ¤ä½ç½®
        time_elapsed = time.time() - detection_time
        predicted_cY = cY - CONVEYOR_SPEED * (PREDICTION_TIME + time_elapsed)
        
        print(f"ğŸ“ é åˆ¤ä½ç½®: ({cX}, {predicted_cY:.2f}), å»¶é²: {time_elapsed:.3f}s")
        
        # åªåœ¨æœ‰ counter æ™‚æ›´æ–°è¨ˆæ•¸
        if counter is not None:
            counter.update_counts(class_name)
        
        # ç­‰å¾…åˆ°é”æœ€ä½³å¤¾å–æ™‚æ©Ÿ
        wait_time = PICKUP_DELAY - time_elapsed
        if wait_time > 0:
            print(f"â³ ç­‰å¾… {wait_time:.3f} ç§’åˆ°é”æœ€ä½³å¤¾å–ä½ç½®")
            time.sleep(wait_time)
        
        # è™•ç†ä¸åŒé¡è‰²çš„ç‰©ä»¶
        if class_name in ['blue', 'yellow', 'green', 'red']:
            color_state = class_name
            
            # æ’­æ”¾å°æ‡‰éŸ³æ•ˆï¼ˆéé˜»å¡ï¼‰
            audio_map = {'blue': 11, 'yellow': 12, 'green': 13, 'red': 14}
            audio.speak(audio_map[class_name])
            
            # åŸ·è¡Œå¤¾å–å‹•ä½œ
            print(f"ğŸ¤– åŸ·è¡Œå¤¾å–: {class_name}")
            dobot.dobot_work(cX, predicted_cY, class_name, 8)
            
        elif class_name == 'broken':
            print("ğŸ”§ è™•ç†ç ´æç‰©ä»¶")
            audio.speak(16)
            dobot.run_conveyor()
            
        print(f"âœ… ç‰©ä»¶è™•ç†å®Œæˆ: {class_name}")
        
    except Exception as e:
        print(f"âŒ è™•ç†ç‰©ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
    finally:
        # æ¸…ç†è™•ç†è¨˜éŒ„ï¼ˆä¸€æ®µæ™‚é–“å¾Œï¼‰
        def cleanup_processed_id():
            time.sleep(10)  # 10ç§’å¾Œæ¸…ç†
            with processing_lock:
                if obj_id in processed_objects:
                    processed_objects.discard(obj_id)
        
        threading.Thread(target=cleanup_processed_id, daemon=True).start()

def main_loop():
    """ä¸»è¿´åœˆï¼ˆéé˜»å¡ï¼‰"""
    global running, flag_start_work, counter
    print("ä¸»è¿´åœˆå•Ÿå‹•")
    
    # åˆå§‹åŒ–Dobot
    dobot.initialize()
    
    # noweb æ¨¡å¼è‡ªå‹•é–‹å§‹å·¥ä½œ
    if noweb_mode:
        print("noweb æ¨¡å¼ï¼šè‡ªå‹•é–‹å§‹å·¥ä½œ")
        flag_start_work = True
    
    frame_count = 0
    last_detection_time = time.time()

    while running:
        try:
            frame_count += 1
            current_time = time.time()
            
            # è™•ç†å½±åƒ
            frame, model_objects, unknown_objects = vision.process_frame()
            if frame is None:
                print("æ”å½±æ©Ÿè®€å–å¤±æ•—ï¼Œç­‰å¾…æ¢å¾©...")
                time.sleep(0.1)
                continue

            # åªåœ¨ web æ¨¡å¼ä¸‹å‚³é€å½±åƒåˆ°å‰ç«¯
            if not noweb_mode and frame_count % 3 == 0:  # é™ä½å‚³è¼¸é »ç‡
                _, buffer = cv2.imencode('.jpg', frame)
                jpg_as_text = base64.b64encode(buffer).decode('utf-8')
                socketio.emit('frame', {'frame': jpg_as_text})

            # å¦‚æœé–‹å§‹å·¥ä½œæ¨¡å¼
            if flag_start_work:
                # è™•ç†å·²çŸ¥ç‰©ä»¶
                if model_objects:
                    last_detection_time = current_time
                    print(f"ğŸ” æª¢æ¸¬åˆ° {len(model_objects)} å€‹ç‰©ä»¶")
                    
                    # æŒ‰Xåº§æ¨™æ’åºï¼ˆè™•ç†æœ€å‰é¢çš„ç‰©ä»¶ï¼‰
                    model_objects.sort(key=lambda x: x['center'][0])
                    
                    # ç•°æ­¥è™•ç†æ¯å€‹ç‰©ä»¶
                    for obj in model_objects:
                        threading.Thread(
                            target=process_object_async, 
                            args=(obj, current_time), 
                            daemon=True
                        ).start()
                
                # è™•ç†æœªçŸ¥ç‰©ä»¶
                if unknown_objects:
                    print(f"âš ï¸ æª¢æ¸¬åˆ° {len(unknown_objects)} å€‹æœªçŸ¥ç‰©ä»¶")
                    for obj in unknown_objects:
                        obj_id = get_object_id(obj)
                        
                        with processing_lock:
                            if obj_id not in processed_objects:
                                processed_objects.add(obj_id)
                                
                                if counter is not None:
                                    counter.update_counts('unknown')
                                
                                print("ğŸš¨ æª¢æ¸¬åˆ°ç•°ç‰©ï¼Œè™•ç†ä¸­...")
                                audio.speak(15)
                                
                                # ç•°æ­¥è™•ç†ç•°ç‰©
                                def handle_unknown():
                                    dobot.run_conveyor()
                                
                                threading.Thread(target=handle_unknown, daemon=True).start()

            # é¡¯ç¤ºå½±åƒ
            cv2.imshow("camera_input", frame)
            
            # è™•ç† OpenCV è¦–çª—äº‹ä»¶
            key = cv2.waitKey(1) & 0xFF
            if key == ord('q'):
                print("ä½¿ç”¨è€…æŒ‰ä¸‹ 'q'ï¼ŒçµæŸç¨‹å¼")
                running = False
                break
            elif key == ord('s') and noweb_mode:
                flag_start_work = True
                print("ğŸŸ¢ é–‹å§‹å·¥ä½œ")
            elif key == ord('p') and noweb_mode:
                flag_start_work = False
                print("ğŸ”´ æš«åœå·¥ä½œ")
            elif key == ord('r') and noweb_mode:
                # é‡ç½®è™•ç†è¨˜éŒ„
                with processing_lock:
                    processed_objects.clear()
                print("ğŸ”„ é‡ç½®è™•ç†è¨˜éŒ„")
            
            # é¡¯ç¤ºé‹è¡Œç‹€æ…‹
            if frame_count % 100 == 0:  # æ¯100å¹€é¡¯ç¤ºä¸€æ¬¡ç‹€æ…‹
                status = "ğŸŸ¢ é‹è¡Œä¸­" if flag_start_work else "ğŸ”´ æš«åœä¸­"
                print(f"ğŸ“Š ç‹€æ…‹: {status}, å¹€æ•¸: {frame_count}, è™•ç†ä¸­ç‰©ä»¶: {len(processed_objects)}")
            
            # æ§åˆ¶è¿´åœˆé »ç‡
            if noweb_mode:
                time.sleep(0.01)  # æé«˜è™•ç†é »ç‡
            else:
                socketio.sleep(0.03)
                
        except Exception as e:
            print(f"âŒ ä¸»è¿´åœˆéŒ¯èª¤: {e}")
            time.sleep(0.1)

    # æ¸…ç†
    cleanup()

def cleanup():
    """æ¸…ç†å‡½æ•¸"""
    global running
    running = False
    print("ğŸ§¹ é–‹å§‹æ¸…ç†è³‡æº...")
    cv2.destroyAllWindows()
    vision.release()
    dobot.disconnect()
    print("âœ… ç¨‹å¼å·²æ¸…ç†ä¸¦çµæŸ")

def signal_handler(sig, frame):
    """è™•ç†ç¨‹å¼çµ‚æ­¢ä¿¡è™Ÿ"""
    print("âš ï¸ æ¥æ”¶åˆ°çµ‚æ­¢ä¿¡è™Ÿ")
    cleanup()
    exit(0)

# æ¥æ”¶å‰ç«¯æ§åˆ¶æŒ‡ä»¤ï¼ˆåªåœ¨ web æ¨¡å¼ä¸‹ä½¿ç”¨ï¼‰
@socketio.on('control')
def handle_control(data):
    global flag_start_work
    command = data.get('command')
    print(f"ğŸ“¡ æ”¶åˆ°æ§åˆ¶æŒ‡ä»¤: {command}")
    if command == 'start':
        flag_start_work = True
        print("ğŸŸ¢ GO Work")
    elif command == 'stop':
        flag_start_work = False
        print("ğŸ”´ Finish")
    elif command == 'reset':
        with processing_lock:
            processed_objects.clear()
        print("ğŸ”„ é‡ç½®è™•ç†è¨˜éŒ„")

@socketio.on('connect')
def on_connect():
    print("ğŸ”Œ WebSocket å®¢æˆ¶ç«¯å·²é€£ç·š")
    global running
    running = True
    threading.Thread(target=main_loop, daemon=True).start()

@socketio.on('disconnect')
def on_disconnect():
    print("ğŸ”Œ WebSocket å®¢æˆ¶ç«¯å·²æ–·ç·š")

if __name__ == '__main__':
    signal.signal(signal.SIGINT, signal_handler)

    print("=" * 50)
    print("ğŸ¤– æ©Ÿæ¢°æ‰‹è‡‚é€£çºŒé‹è¡Œç³»çµ±å•Ÿå‹•")
    print("=" * 50)
    print(f"ğŸ“Š è¼¸é€å¸¶é€Ÿåº¦: {CONVEYOR_SPEED} åƒç´ /ç§’")
    print(f"â±ï¸ é åˆ¤æ™‚é–“: {PREDICTION_TIME} ç§’")
    print(f"ğŸ¯ å¤¾å–å»¶é²: {PICKUP_DELAY} ç§’")
    print(f"ğŸ’¤ ç¡çœ æ™‚é–“: {SLEEP_TIME} ç§’")
    
    if noweb_mode:
        print("ğŸ”§ æ¨¡å¼: noweb (ç„¡ç¶²é ä»‹é¢)")
        print("âŒ¨ï¸ æ§åˆ¶èªªæ˜:")
        print("   - æŒ‰ 'q' é€€å‡ºç¨‹å¼")
        print("   - æŒ‰ 's' é–‹å§‹å·¥ä½œ")
        print("   - æŒ‰ 'p' æš«åœå·¥ä½œ")
        print("   - æŒ‰ 'r' é‡ç½®è™•ç†è¨˜éŒ„")
        print("   - Ctrl+C å¼·åˆ¶é€€å‡º")
    else:
        print("ğŸŒ æ¨¡å¼: web (å«ç¶²é ä»‹é¢)")
        print("ğŸ”— WebSocket åŸ è™Ÿ: 5000")
    
    print("=" * 50)

    # åˆ¤æ–·æ˜¯å¦å‚³å…¥ "noweb" æ¨¡å¼
    if noweb_mode:
        try:
            # ç›´æ¥åŸ·è¡Œä¸»è¿´åœˆï¼Œä¸é–‹ Flask server
            main_loop()
        except KeyboardInterrupt:
            print("âš ï¸ æ¥æ”¶åˆ° Ctrl+Cï¼Œæ­£åœ¨é—œé–‰ç¨‹å¼...")
            cleanup()
    else:
        # æ­£å¸¸å•Ÿå‹• WebSocket + Flask
        try:
            socketio.run(app, host='0.0.0.0', port=5000)
        except KeyboardInterrupt:
            print("âš ï¸ æ¥æ”¶åˆ° Ctrl+Cï¼Œæ­£åœ¨é—œé–‰ Flask ä¼ºæœå™¨...")
            cleanup()